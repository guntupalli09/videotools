#!/usr/bin/env node
/**
 * Syncs PostHog vars from server/.env to client/.env so the client gets VITE_POSTHOG_*.
 * Run from repo root: node scripts/sync-posthog-env.js
 * Creates client/.env if missing; only writes VITE_POSTHOG_KEY and VITE_POSTHOG_HOST.
 */
const path = require('path')
const fs = require('fs')

const root = path.join(__dirname, '..')
const serverEnvPath = path.join(root, 'server', '.env')
const clientEnvPath = path.join(root, 'client', '.env')

if (!fs.existsSync(serverEnvPath)) {
  console.error('server/.env not found. Create it with POSTHOG_KEY and optionally POSTHOG_HOST.')
  process.exit(1)
}

const serverEnv = fs.readFileSync(serverEnvPath, 'utf8')
const getVar = (name) => {
  const m = serverEnv.match(new RegExp(`^${name}=(.+)$`, 'm'))
  return m ? m[1].trim().replace(/^["']|["']$/g, '') : null
}

const key = getVar('POSTHOG_KEY')
const host = getVar('POSTHOG_HOST') || 'https://app.posthog.com'

if (!key) {
  console.error('POSTHOG_KEY not set in server/.env')
  process.exit(1)
}

const lines = [
  '# Auto-generated by scripts/sync-posthog-env.js from server/.env',
  `VITE_POSTHOG_KEY=${key}`,
  `VITE_POSTHOG_HOST=${host}`,
  '',
]
fs.writeFileSync(clientEnvPath, lines.join('\n'), 'utf8')
console.log('Wrote client/.env with VITE_POSTHOG_KEY and VITE_POSTHOG_HOST.')
console.log('Restart the client dev server (or rebuild) so it picks up the env.')
