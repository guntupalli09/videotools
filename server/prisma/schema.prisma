// VideoText production user store. Run: npx prisma generate, npx prisma migrate deploy
generator client {
  provider = "prisma-client-js"
}

// Connection URL is set in prisma.config.ts (Prisma 7+)
datasource db {
  provider = "postgresql"
}

model User {
  id                       String   @id
  email                    String
  passwordHash             String   @default("")
  plan                     String   // free | basic | pro | agency
  stripeCustomerId         String?  @unique
  subscriptionId           String?
  paymentMethodId          String?
  billingPeriodStart       DateTime?
  billingPeriodEnd         DateTime?
  passwordSetupToken       String?
  passwordSetupExpiresAt   DateTime?
  passwordSetupUsed        Boolean  @default(false)
  passwordResetToken       String?
  passwordResetExpiresAt   DateTime?
  usageThisMonth           Json     // { totalMinutes, videoCount, ... resetDate (ISO string) }
  limits                   Json     // PlanLimits
  overagesThisMonth        Json     // { minutes, languages, batches, totalCharge }
  createdAt                DateTime
  updatedAt                DateTime
}

// Batch job state shared by API and worker (persisted so separate containers see same state).
model BatchJobRecord {
  id               String    @id
  userId           String
  totalVideos      Int
  totalDuration    Int       // seconds
  processedVideos  Int       @default(0)
  failedVideos     Int       @default(0)
  status           String    // queued | processing | completed | failed | partial
  zipPath          String?
  zipSize          Int?
  errors           Json      @default("[]") // [{ videoName, reason }]
  createdAt        DateTime
  completedAt      DateTime?
  expiresAt        DateTime
}

// User feedback from Tex panel (post-job completion). No auth required to submit.
model Feedback {
  id              String   @id @default(cuid())
  toolId          String?  // e.g. video-to-transcript, video-to-subtitles (where stars were collected)
  stars           Int?     // 1-5
  comment         String   @default("")
  userId          String?  // if logged in
  userNameOrEmail String?  // for free users: name or email when they share it
  planAtSubmit    String?  // free | basic | pro | agency at time of feedback
  createdAt       DateTime @default(now())
}
